# https://taskfile.dev

version: "3"

tasks:
  prepare:
    cmds:
      - npx -y mustache config/{{.ENV}}.json substreams.template.yaml > substreams.yaml

  prepare:dev:
    cmds:
      - task: prepare
        vars:
          ENV: dev

  proto:
    cmds:
      - substreams protogen ./substreams.yaml --exclude-paths="sf/substreams,google"

  build:
    cmds:
      - cargo build --release --target wasm32-unknown-unknown

  pack:
    cmds:
      - substreams pack ./substreams.yaml

  roll:dev:
    cmds:
      # - task: prepare:dev
      - task: proto
      - task: build
      - task: pack
  
  run:
    internal: true
    cmds:
      - task: proto
      - task: build 
      - substreams run -e {{.FIREHOSE_URL}} ./substreams.yaml map_registry --start-block {{.START_BLOCK}} --stop-block {{.STOP_BLOCK}} --network {{.NETWORK}}

  run:dev:
    cmds:
      - task: run
        vars:
          START_BLOCK: 44841100
          STOP_BLOCK: 44841398
          FIREHOSE_URL: mumbai.streamingfast.io:443
          NETWORK: dev

  # TODO: Use staging values here. Right now just fake dev values
  run:stg:
    cmds:
      - task: run
        vars:
          START_BLOCK: 41877860
          STOP_BLOCK: 41877950
          FIREHOSE_URL: mumbai.streamingfast.io:443
          NETWORK: stg